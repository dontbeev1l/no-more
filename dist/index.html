<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style/style.css">
    <title>Example design</title>
</head>
<body>
    <app-main></app-main>
    <script src="./scripts/no-more.js"></script>
<template id="buttonTemplate">
    <style>
        .mac-button {
            height: 20px;
            text-align: center;
            min-width: 100px;
            box-sizing: border-box;
            padding: 0 10px;
            font-family: SFPro;
            display: inline-block;
            background: linear-gradient(180deg, #50A4F9 0%, #005CFF 100%),
                linear-gradient(180deg, #6CB3FA 0%, #067DFF 100%);
            color: #FFFFFF;
            border: 0.5px solid #50A4F9;
            border-radius: 3.5px;
            font-size: 13px;
            line-height: 19px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0px 0.5px 0.5px 0px rgba(0, 0, 0, 0.15);
        }
    </style>
    <div class="mac-button">
        <slot></slot>
    </div>
</template>
<script>
    'use strict';

    window.customElements.define('mac-button', class extends NMComponent {
        constructor() {
            super();
            this.attachTemplate('buttonTemplate');
        }
    })

</script><template id="contentMenuBrTemplate">
    <style>
        .br {
            height: 19px;
            background: rgba(0, 0, 0, .07);
            height: 2px;
            margin: 5px 0;
        }
    </style>
    <div class="br">
    </div>
</template>
<script>
    window.customElements.define('mac-context-menu-br', class extends NMComponent {
        constructor() {
            super();
            this.attachTemplate('contentMenuBrTemplate');
        }
    });
</script><template id="contentMenuItemTemplate">
    <style>
        .item {
            height: 19px;
            box-sizing: border-box;
            padding: 0 12px 0 20px;
            font-family: SFPro;
            color: rgba(0, 0, 0, .9);
            font-size: 14px;
            line-height: 14px;
            font-weight: 500;
            user-select: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .item_active {
            background: #3897FE;
            color: #fff;
            position: relative;
        }

        .arrow_black {
            display: block;
            opacity: .9;
        }

        .arrow_white {
            display: none;
        }

        .item_active .arrow_black {
            display: none;
        }

        .item_active .arrow_white {
            display: block;
        }

        /* .submenu-arrow {} */

        .submenu-arrow:not(.submenu-arrow_active) {
            display: none;
        }
    </style>
    <div class="item">
        <slot></slot>

        <div class="submenu-arrow">
            <svg class="arrow_black" width="9" height="11" viewBox="0 0 9 11" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M0 10.5L0 0.5L9 5.5L0 10.5Z" fill="black" />
            </svg>

            <svg class="arrow_white" width="9" height="11" viewBox="0 0 9 11" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M0 10.5L0 0.5L9 5.5L0 10.5Z" fill="white" />
            </svg>
        </div>

    </div>
</template>
<script>

    class ContentMenuItemComponent extends NMComponent {
        constructor() {
            super();

            this.opened = false

            this.attachTemplate('contentMenuItemTemplate');
        }

        attributeChangedCallback(name, oldValue, newValue) {
            switch (name) {
                case ContentMenuItemComponent.ARRT_IS_SUBMENU:
                    _attrSubmenuChagned(oldValue, newValue);
                    break;
            }
        }

        attachSubmenu(contextMenuElement) {
            this.submenu = contextMenuElement;

            this.shadowRoot.querySelector('.submenu-arrow').classList.add('submenu-arrow_active');

            this.addEventListener('click', (e) => {
                if (e.target === this) {
                    this._toogleSubmenu();
                }
            });
        }

        _toogleSubmenu() {
            if (this.opened) {
                this._closeSubmenu()
            } else {
                this._openSubmenu();
            }
        }

        _closeSubmenu() {
            this.opened = false;
            this.shadowRoot.querySelector('.item').classList.remove('item_active');
            this.submenu.close();
        }

        _openSubmenu() {
            this.opened = true;
            this.shadowRoot.querySelector('.item').classList.add('item_active');
            this.submenu.open();
        }
    }

    window.customElements.define('mac-context-menu-item', ContentMenuItemComponent);
</script><template id="contentMenuTemplate">
    <style>
        .context-menu {
            background: rgba(0, 0, 0, .15);
            backdrop-filter: blur(10px);
            border-radius: 4px;
            position: fixed;
            padding: 4px 0;
        }

        .context-menu_sub {
            position: absolute;
            left: 100%;
            top: -4px;
        }

        .context-menu:not([data-state=open]) {
            display: none;
        }

        .context-menu[data-state=open] {
            display: block;
        }
    </style>
    <div class="context-menu">
        <slot></slot>
    </div>
</template>
<script>
    window.customElements.define('mac-context-menu', class ContextMenuComponent extends NMComponent {
        static ATTR_STATE = 'data-state';
        static STATE_OPENED = 'open';
        static STATE_CLOSED = 'closed';

        constructor() {
            super();

            this.attachTemplate('contentMenuTemplate');
            this._checkIsSubmenu();
        }

        attributeChangedCallback(name, oldValue, newValue) {
            switch (name) {
                case ContentMenuItemComponent.ATTR_STATE:
                    _attrStateChagned(oldValue, newValue);
                    break;
            }
        }

        open(x, y) {
            if (!this.isSubmenu) {
                this.shadowRoot.querySelector('.context-menu').style.left = `${x}px`;
                this.shadowRoot.querySelector('.context-menu').style.top = `${y}px`;
            }

            this.setAttribute(ContextMenuComponent.ATTR_STATE, ContextMenuComponent.STATE_OPENED);
            this.shadowRoot.querySelector('.context-menu').setAttribute(ContextMenuComponent.ATTR_STATE, ContextMenuComponent.STATE_OPENED);
        }

        close() {
            this.setAttribute(ContextMenuComponent.ATTR_STATE, ContextMenuComponent.STATE_CLOSED);
            this.shadowRoot.querySelector('.context-menu').setAttribute(ContextMenuComponent.ATTR_STATE, ContextMenuComponent.STATE_CLOSED);
        }

        _attrStateChagned() {
            //
        }

        _checkIsSubmenu() {

            if (this.parentElement instanceof ContentMenuItemComponent) {
                this.isSubmenu = true;
                this.shadowRoot.querySelector('.context-menu').classList.add('context-menu_sub');
                this.parentElement.attachSubmenu(this);
            }
        }

    });
</script><template id="windowtitleTemplate">
    <style>
        .window-title {
            position: relative;
            height: 16px;
            background: linear-gradient(180deg, #EDECED 1.45%, #D2D1D2 97.1%);
            box-shadow: inset 0px 0.5px 0.5px rgba(255, 255, 255, 0.5), inset 0px -0.5px 0px #B7B4B7, inset 0px -1px 0px rgba(183, 180, 183, 0.3);
        }

        .title {
            text-align: center;
            width: 100%;
            position: absolute;
            pointer-events: none;
            height: 100%;
            line-height: 16px;
            font-size: 11px;
            font-family: SFPro;
            color: rgba(0, 0, 0, 0.73);
            top: 0;
            left: 0;
        }

        .control {
            width: 10px;
            height: 10px;
            box-sizing: border-box;
            background: #D0D0D0;
            border: 0.5px solid #B2B2B2;
            transition: all 200ms ease;
            border-radius: 5px;
        }

        .control+.control {
            margin-left: 8px;
        }

        .control_close:hover {
            background: #FF6157;
            border: 0.5px solid #E24640;
        }

        .controls {
            margin-left: 8px;
            margin-top: 3px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
    </style>
    <div class="window-title">
        <div class="controls">
            <div class="control control_close"></div>
            <div class="control control_maximize"></div>
            <div class="control control_rollup"></div>
        </div>
        <div class="title">
            <slot></slot>
        </div>
    </div>
</template>

<script>
    'use strict';

    window.customElements.define('mac-window-title', class extends NMComponent {
        constructor() {
            super();
            this.attachTemplate('windowtitleTemplate');

            this.defineEvents();
        }

        defineEvents() {
            this.shadowRoot.querySelector('.control_close').addEventListener('click', e => {
                this.dispatchEvent(new NMEvent('closeClick', null, { data: { msg: 'Test message' } }));
            });
        }
    });
</script><template id="windowTemplate">
    <style>
        .window {
            position: fixed;
            box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.15);
            background: #F7F7F7;
            border: 0.5px solid rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
        }

        .window-content {
            flex-grow: 1;
            width: 100%;
        }
    </style>
    <div class="window">
        <mac-window-title class="window-title" draggable="true">This is window</mac-window-title>
        <div class="window-content">
            <slot></slot>
        </div>
    </div>
</template>

<script>
    'use strict';

    window.customElements.define('mac-window', class MacWindowComponent extends NMComponent {
        static BORDER_FIXING_SIZE = 0.5;
        static ZERO_FIXING_AREA = 50;

        constructor() {
            super();

            this.attachTemplate('windowTemplate');
            this._addDrag();

            this.position = { x: +this.getAttribute('data-position-x') || 0, y: +this.getAttribute('data-position-x') || 0 };
            this.updatePosition();

            this.listenClosing();
        }

        listenClosing() {
            this.shadowRoot.querySelector('mac-window-title').addEventListener('closeClick', (e) => this.dispatchEvent(e.clone()));
        }

        updatePosition() {
            this.shadowRoot.querySelector('.window').style.left = `${this.position.x}px`;
            this.shadowRoot.querySelector('.window').style.top = `${this.position.y}px`;
        }

        _addDrag() {
            const titleElement = this.shadowRoot.querySelector('.window-title');
            const offset = { x: 0, y: 0 };

            titleElement.addEventListener('dragstart', e => {
                const rect = titleElement.getBoundingClientRect();
                offset.x = e.clientX - rect.x + MacWindowComponent.BORDER_FIXING_SIZE;
                offset.y = e.clientY - rect.y + MacWindowComponent.BORDER_FIXING_SIZE;
            });

            titleElement.addEventListener('drag', e => {
                if (e.clientX === 0 && e.clientY === 0
                    && (this.position.x > MacWindowComponent.ZERO_FIXING_AREA || this.position.y > MacWindowComponent.ZERO_FIXING_AREA)
                ) { return; }

                this.position.x = e.clientX - offset.x;
                this.position.y = e.clientY - offset.y;

                this.updatePosition()
            });
        }

    });
</script><template id="mainTemplate">
    <mac-button id="button">Button</mac-button>
    <mac-window>
        <mac-button id="button">Accept</mac-button>
        <mac-button id="button">Close</mac-button>
    </mac-window> 
    <mac-context-menu id="mainContext">
        <mac-context-menu-item>New Folder</mac-context-menu-item>
        <mac-context-menu-br></mac-context-menu-br>
        <mac-context-menu-item id="test">Get Info</mac-context-menu-item>
        <mac-context-menu-br></mac-context-menu-br>
        <mac-context-menu-item>
            Arrange By
            <mac-context-menu>
                <mac-context-menu-item>Name</mac-context-menu-item>
                <mac-context-menu-item>Date</mac-context-menu-item>
                <mac-context-menu-item>Size</mac-context-menu-item>
                <mac-context-menu-br></mac-context-menu-br>
                <mac-context-menu-item>None</mac-context-menu-item>
            </mac-context-menu>

        </mac-context-menu-item>
        <mac-context-menu-item>Show View Options</mac-context-menu-item>
    </mac-context-menu>

</template>
<script>
    'use strict';
    window.customElements.define('app-main', class extends NMComponent {
        constructor() {
            super();
            this.attachTemplate('mainTemplate');

            this.shadowRoot.getElementById('button').addEventListener('click', (e) => {
                console.log(e);
            });

            // console.log(this.shadowRoot.querySelector('mac-window'));
            const mainContext = this.shadowRoot.getElementById('mainContext');
            document.addEventListener('contextmenu', e => {
                e.preventDefault();
                mainContext.open(e.clientX, e.clientY);
            })

            this.shadowRoot.getElementById('button').addEventListener('click', () => {
                this.shadowRoot.getElementById('test').innerHTML += `
                <mac-context-menu>
                    <mac-context-menu-item>Name</mac-context-menu-item>
                    <mac-context-menu-item>Date</mac-context-menu-item>
                    <mac-context-menu-item>Size</mac-context-menu-item>
                    <mac-context-menu-br></mac-context-menu-br>
                    <mac-context-menu-item>None</mac-context-menu-item>
                </mac-context-menu>
                `;
            });

            // this.shadowRoot.querySelector('mac-window').addEventListener('closeClick', console.log);
        }
    })
</script></body>
</html>
